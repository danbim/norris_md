<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>NorrisMd Home</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href="img/favicon.ico"/>

    <style>
        body {
            padding-top: 70px;
            color: #555555;
        }
        pre {
            font-size: 9pt;
        }
        .img-bordered {
            border: 1px solid #ccc;
        }
    </style>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>

<div id="norris_md-nav">
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
				<a class="navbar-brand" href="#" onclick="navigate('/')"><span class="glyphicon glyphicon-home"/></a>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav"></ul>
            </div>
        </div>
    </nav>
</div>

<div class="container">
	<div id="norris_md-content"></div>
</div>

<script type="text/x-mustache" id="norris_md-template-menu-dir">
	<li class="dropdown">
		<a href="#{{Path}}" class="dropdown-toggle norrs_md-menu-dir" data-toggle="dropdown">{{Title}}<span
class="caret"></span></a>
		<ul class="dropdown-menu" role="menu"></ul>
	</li>
</script>

<script type="text/x-mustache" id="norris_md-template-menu-file">
	<li>
		<a href="#{{Path}}">{{Title}}</a>
	</li>
</script>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="js/jquery-2.1.1.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="js/bootstrap.min.js"></script>
<script src="js/mustache-0.8.1.js"></script>
<script>

function addMenuItem(item, parent) {
	var parentElem, template;
	if (parent) {
		parentElem = $('#norris_md-nav .navbar-nav a[href="#' + parent.Path + '"]').siblings('ul.dropdown-menu');
	} else {
		parentElem = $('#norris_md-nav .navbar-nav');
	}
	if (item.NodeType == 'file') {
		template = $('#norris_md-template-menu-file').html();
		parentElem.append(Mustache.render(template, item));
	}
	if (item.NodeType == 'dir') {
		template = $('#norris_md-template-menu-dir').html();
		parentElem.append(Mustache.render(template, item));
		item.Children.forEach(function(child) { addMenuItem(child, item); });
	}
}

function buildNavigation() {
	var onSuccess = function(root, textStatus, jqXHR) {
		root.Children.forEach(function(child) { addMenuItem(child, undefined) });
	}
	var onError = function(jqXHR, textStatus, errorThrown) {
		console.log(jqXHR, textStatus, errorThrown);
	}
	$.ajax("/norris_md/tree.json", {
		accepts: "application/json",
		success: onSuccess,
		error: onError
	});
}

function onCreated(evt) {
	var splitPath = evt.Path.split("/");
	if (splitPath.length > 2) {
		window.alert('Received an update for a newly created content document. Unfortunately the path ' + evt.Path + ' contains more than one level of folder hierarchy which is currently not supported by NorrisMd');
		return;
	}
	if (splitPath.length == 1) {
		addMenuItem(evt.NodeInfo, undefined);
	} else {
		addMenuItem(evt.NodeInfo, {Path:splitPath[0]});
	}
}

function onUpdated(evt) {

	// re-render page if we're currently displaying the udpated site
	if (window.location.hash.substr(1) == evt.Path) {

	}
	console.log(event.data);
}

function onDeleted(evt) {
	var splitPath = evt.Path.split("/");
	if (splitPath.length > 2) {
		window.alert('Received an update for a newly created content document. Unfortunately the path ' + evt.Path + ' contains more than one level of folder hierarchy which is currently not supported by NorrisMd');
		return;
	}

	// remove menu item (if directory is removed it will also remove all children from navigation)
	$('#norris_md-nav a[href="#' + evt.Path + '"]').parent('li').remove();
	
	// if we're currently displaying one of the removed pages we shall navigate home
	if (evt.Path.indexOf(window.location.hash.substr(1)) > -1) {
		navigate('');
	}
}

function listenForUpdates() {
	var socket = new WebSocket("ws://" + document.location.host + "/norris_md/ws");
	socket.onmessage = function (event) {
		var evt = JSON.parse(event.data);
		switch (evt.Type) {
			case 'CREATED':
				onCreated(evt);
				break;
			case 'UPDATED':
				onUpdated(evt);
				break;
			case 'DELETED':
				onDeleted(evt);
				break;
		}
	}
}

function navigate(path) {

	$("#norris_md-nav").find('li').toggleClass('active', false);

	$("#norris_md-nav")
		.find("li a[href='#" + path + "']")
		.closest('li.dropdown')
		.toggleClass('active', true);
	
	$("#norris_md-nav")
		.find("li a[href='#" + path + "']")
		.closest('li')
		.toggleClass('active', true);

	loadPage(path);
}

function loadPage(path) {
	$("#norris_md-content").empty();
	$("#norris_md-content").append($('<img src="img/ajax-loader.gif"/>'));
	$.ajax("/norris_md/content/" + path, {
		success: function(html) {
			$("#norris_md-content").empty();
			$("#norris_md-content").html(html);
		},
		error: function(jqXHR, textStatus, errorThrown) {
			html = $('<div/>')
				.append('<h2>jqXHR</h2>')
				.append('<pre>' + JSON.stringify(jqXHR, '', '  ') + '</pre>')
				.append('<h2>textStatus</h2>')
				.append('<pre>' + textStatus + '</pre>')
				.append('<h2>errorThrown</h2>')
				.append('<pre>' + errorThrown + '</pre>');
			$("#norris_md-content").empty();
			$("#norris_md-content").html(html);
		}
	});
}

$(function() {
	buildNavigation();
	listenForUpdates();
	navigate(window.location.hash.substr(1));
});

window.onhashchange = function() {
	var target = window.location.hash.substr(1);
	if (target == '') {
		window.location.hash = '#Home.md';
		target = 'Home.md';
	}
	navigate(target);
};

</script>
</body>
</html>
